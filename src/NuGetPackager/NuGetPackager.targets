<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="BuildPackage" Condition="'$(Configuration)' == 'Release'">

    <PropertyGroup>
      <NuGetFolder>$(SolutionDir)..\nugets</NuGetFolder>
      <NuGetExePath>$(MSBuildThisFileDirectory)\NuGet.exe</NuGetExePath>

      <NuSpecFile>$(SolutionDir)..\packaging\nuget\$(AssemblyName).nuspec</NuSpecFile>

      <NuGetCommand Condition=" '$(OS)' == 'Windows_NT'">"$(NuGetExePath)"</NuGetCommand>
      <NuGetCommand Condition=" '$(OS)' != 'Windows_NT' ">mono --runtime=v4.0.30319 "$(NuGetExePath)"</NuGetCommand>
      <BuildCommand>$(NuGetCommand) pack "$(NuSpecFile)"</BuildCommand>
      <BuildCommand>$(BuildCommand) -Version $(GfvNuGetVersion)</BuildCommand>
      <BuildCommand>$(BuildCommand) -OutputDirectory "$(NuGetFolder)"</BuildCommand>
      <BuildCommand>$(BuildCommand) -NoPackageAnalysis</BuildCommand>
      <BuildCommand>$(BuildCommand) -NonInteractive</BuildCommand>
    </PropertyGroup>

    <MakeDir Directories="$(NuGetFolder)" Condition="!Exists('$(NuGetFolder)')" />

    <Exec Command="$(BuildCommand)"
          Condition=" '$(OS)' != 'Windows_NT' " />

    <Exec Command="$(BuildCommand)"
          LogStandardErrorAsError="true"
          Condition=" '$(OS)' == 'Windows_NT' " />
  </Target>

  <PropertyGroup>
    <BuildDependsOn>
      $(BuildDependsOn);
      UpdateAssemblyInfo;
      BuildPackage
    </BuildDependsOn>
  </PropertyGroup>

</Project>